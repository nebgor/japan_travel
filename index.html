<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Japan Travel · Globe + Day Plan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/styles.css" />
    <style>
      body {
        margin: 0;
        background: radial-gradient(circle at 20% 20%, rgba(14, 116, 209, 0.25), transparent 55%),
          radial-gradient(circle at 80% 0%, rgba(14, 116, 209, 0.15), transparent 45%), #04070f;
        color: #f7fbff;
        font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      }
      .hero h1 {
        margin: 0.2rem 0;
        font-size: clamp(2.2rem, 4vw, 3.2rem);
        line-height: 1.1;
      }
      nav a {
        color: inherit;
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        margin-right: 0.4rem;
      }
      nav a.active {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
      }
      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1.6fr) minmax(280px, 1fr);
        gap: 1.5rem;
        align-items: start;
      }
      .sidebar {
        position: sticky;
        top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .panel {
        background: rgba(3, 7, 24, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 1rem;
        padding: 1rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      }
      .day-card .gallery img.parallax-img {
        transition: transform 0.2s ease;
      }
      @media (max-width: 960px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          position: relative;
          top: 0;
        }
      }
      canvas#globe {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        opacity: 0.28;
      }
      .overlay {
        position: relative;
        z-index: 1;
      }
      .stay-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
    </style>
  </head>
  <body>
    <canvas id="globe"></canvas>
    <div class="overlay">
      <div class="page-shell">
        <nav aria-label="Pages">
          <a class="active" href="/japan_travel/index.html">Globe View</a>
          <a href="/japan_travel/timeline.html">Timeline</a>
        </nav>

        <div class="hero">
          <p class="chip">Family of 5 · PER → SIN → Tokyo → Hakuba → Tokyo → SIN → PER</p>
          <h1>Japan 16-day powder + city, then Singapore wind-down</h1>
          <p>Chronological, wake-to-sleep plan with buffers, live links, and globe overview.</p>
          <div class="dataset-toggle" id="dataset-toggle">
            <button type="button" data-set="jan" class="active">Jan 8–30 Hakuba/Tokyo/SIN</button>
            <button type="button" data-set="hakuba">Hakuba · Tokyo (Dec/Jan)</button>
          </div>
          <div class="summary-grid">
            <div class="summary-chip"><strong>Trip window</strong><p>8–30 Jan</p></div>
            <div class="summary-chip"><strong>Japan days</strong><p>~16 days Tokyo + Hakuba</p></div>
            <div class="summary-chip"><strong>Singapore</strong><p>Buffers before/after Japan</p></div>
            <div class="summary-chip"><strong>Family</strong><p>2 adults · 18yo · 14yo · 7yo</p></div>
          </div>
        </div>

        <div class="layout">
          <div class="main-column">
            <section class="resource-panel section-anchor">
              <h2>Booking + flights</h2>
              <p class="chip">Use these to lock the PER→SIN→TYO→Hakuba →SIN→PER legs</p>
              <div class="actions-grid" id="actions-grid"></div>
              <div class="flight-grid" id="flight-grid"></div>
            </section>

            <section id="days" class="cards-panel section-anchor">
              <h2>Day-by-day (wake → sleep)</h2>
              <div id="day-cards"></div>
            </section>

            <section id="stays" class="stays-panel section-anchor">
              <h2>Where to stay (Japan)</h2>
              <p class="chip">Walk-to-lifts in Hakuba · easy rail in Tokyo</p>
              <div class="stays-grid" id="stays-grid"></div>
            </section>
          </div>

          <aside class="sidebar">
            <div class="panel">
              <h3>Live info</h3>
              <p class="chip">Weather with forecast links</p>
              <div id="weather-grid">
                <div class="weather-card" data-loc="tokyo">
                  <div class="title">Tokyo</div>
                  <div class="temp" id="temp-tokyo">Loading…</div>
                  <div class="desc" id="desc-tokyo"></div>
                </div>
                <div class="weather-card" data-loc="hakuba">
                  <div class="title">Hakuba</div>
                  <div class="temp" id="temp-hakuba">Loading…</div>
                  <div class="desc" id="desc-hakuba"></div>
                </div>
              </div>
            </div>
            <div class="panel">
              <h3>Emergency</h3>
              <p class="chip">110 police · 119 ambulance/fire</p>
              <ul class="sidebar-links" id="emergency-links"></ul>
            </div>
            <div class="panel">
              <h3>Slope maps</h3>
              <p class="chip">Trail maps (new tab)</p>
              <ul class="sidebar-links" id="map-links"></ul>
            </div>
            <div class="panel">
              <h3>Cams & news</h3>
              <p class="chip">Open in new tab</p>
              <ul class="sidebar-links" id="cam-links"></ul>
              <ul class="sidebar-links" id="news-links"></ul>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <script src="data.js?v=7"></script>
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js';
      import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/controls/OrbitControls.js';
      import ThreeGlobe from 'https://cdn.jsdelivr.net/npm/three-globe@2.27.12/dist/three-globe.module.js';

      const data = window.TripData || {};
      const datasets = { hakuba: data.hakuba || [], jan: data.januaryPlan || [] };
      let currentSet = 'jan';

      const dayCards = document.getElementById('day-cards');
      const actionsGrid = document.getElementById('actions-grid');
      const flightGrid = document.getElementById('flight-grid');
      const staysGrid = document.getElementById('stays-grid');
      const newsList = document.getElementById('news-links');
      const camList = document.getElementById('cam-links');
      const mapLinks = document.getElementById('map-links');
      const emergencyList = document.getElementById('emergency-links');
      const weatherCards = [
        { id: 'tokyo', lat: 35.68, lon: 139.76, title: 'Tokyo', fallback: 'https://www.jma.go.jp/bosai/nowc/#area_type=offices&area_code=130000&center=130&zoom=9' },
        { id: 'hakuba', lat: 36.69, lon: 137.83, title: 'Hakuba', fallback: 'https://www.jma.go.jp/bosai/nowc/#lat=36.69&lon=137.83&zoom=10' }
      ];

      const renderActions = () => {
        actionsGrid.innerHTML = '';
        (data.actions || []).forEach((action) => {
          const card = document.createElement('article');
          card.className = 'action-card';
          card.innerHTML = `
            <h3>${action.title}</h3>
            <p>${action.detail}</p>
            <a href="${action.link}" target="_blank" rel="noreferrer noopener">Open →</a>
          `;
          actionsGrid.appendChild(card);
        });
      };

      const renderFlights = () => {
        flightGrid.innerHTML = '';
        (data.flightOptions || []).forEach((f) => {
          const card = document.createElement('article');
          card.className = 'flight-card';
          card.innerHTML = `
            <h3>${f.leg}</h3>
            <div class="meta">${f.dates} · ${f.carrier}</div>
            <div class="chip">${f.times} · ${f.duration}</div>
            ${f.price ? `<div class="chip">Est. price: ${f.price}</div>` : ''}
            <p class="meta">${f.note}</p>
          `;
          flightGrid.appendChild(card);
        });
      };

      const renderStays = () => {
        staysGrid.innerHTML = '';
        (data.stays || []).forEach((item) => {
          const card = document.createElement('article');
          card.className = 'stay-card';
          card.innerHTML = `
            ${item.image ? `<img src="${item.image}" alt="${item.title}" loading="lazy" />` : ''}
            <h3>${item.title}</h3>
            <p>${item.area}</p>
            <p>${item.detail}</p>
            ${item.link ? `<a target="_blank" rel="noreferrer noopener" href="${item.link}">View options →</a>` : ''}
          `;
          staysGrid.appendChild(card);
        });
      };

      const renderMaps = () => {
        mapLinks.innerHTML = '';
        (data.slopeMaps || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a><div class="meta">${item.area || ''}</div>`;
          mapLinks.appendChild(li);
        });
      };

      const renderNews = () => {
        newsList.innerHTML = '';
        (data.newsFeeds || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a><div class="meta">${item.detail}</div>`;
          newsList.appendChild(li);
        });
      };

      const renderCams = () => {
        camList.innerHTML = '';
        (data.slopeCams || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a><div class="meta">${item.detail}</div>`;
          camList.appendChild(li);
        });
      };

      const renderEmergency = () => {
        emergencyList.innerHTML = '';
        (data.emergencyInfo || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `${item.link ? `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a>` : `<strong>${item.title}</strong>`}<div class="meta">${item.detail}</div>`;
          emergencyList.appendChild(li);
        });
      };

      const buildCard = (entry) => {
        const card = document.createElement('article');
        card.className = 'day-card';
        const planSteps = entry.plan.split(';').map((s) => s.trim()).filter(Boolean);
        const gallery = data.galleryMap?.[entry.location] || data.galleryMap?.[entry.location?.split('→')[0]] || data.galleryMap?.Tokyo || [];
        const energy = data.energyMap[entry.date] || {};

        const galleryMarkup = gallery
          .map(
            (src) =>
              `<img class="parallax-img" src="${src}" alt="${entry.location} highlight" loading="lazy" decoding="async" />`
          )
          .join('');

        const energyMarkup = Object.entries(energy)
          .map(
            ([person, level]) => `
              <span class="energy-pill ${level.toLowerCase()}">${person}: <span>${level}</span></span>
            `
          )
          .join('');

        card.innerHTML = `
          <h3>${entry.date} <span>${entry.location}</span></h3>
          <div class="gallery">${galleryMarkup}</div>
          <div class="chips">
            <span class="chip">Food mid: $${entry.food}</span>
            ${entry.focus ? `<span class="chip">Ski focus: ${entry.focus}</span>` : '<span class="chip">Buffer-smart pacing</span>'}
          </div>
          <p>${planSteps.join(' · ')}</p>
          <div class="chips energy-stack">${energyMarkup}</div>
          <p><strong>Hint:</strong> ${entry.hint || ''}</p>
        `;

        const imgs = card.querySelectorAll('.parallax-img');
        if (window.matchMedia('(pointer:fine)').matches && imgs.length) {
          card.addEventListener('mousemove', (e) => {
            const rect = card.getBoundingClientRect();
            const relY = (e.clientY - rect.top) / rect.height - 0.5;
            const offset = relY * 10;
            imgs.forEach((img) => (img.style.transform = `translateY(${offset}px)`));
          });
          card.addEventListener('mouseleave', () => imgs.forEach((img) => (img.style.transform = 'translateY(0)')));
        }
        return card;
      };

      const renderDays = (key) => {
        dayCards.innerHTML = '';
        const list = datasets[key] || [];
        if (!list.length) {
          dayCards.innerHTML = '<p class="chip">No days available for this plan.</p>';
          return;
        }
        list.forEach((day) => dayCards.appendChild(buildCard(day)));
      };

      document.querySelectorAll('#dataset-toggle button').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#dataset-toggle button').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          currentSet = btn.dataset.set;
          renderDays(currentSet);
        });
      });

      renderActions();
      renderFlights();
      renderStays();
      renderMaps();
      renderNews();
      renderCams();
      renderEmergency();
      renderDays(currentSet);

      const weatherDesc = (code) => {
        const map = {
          0: 'Clear', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast', 45: 'Foggy', 48: 'Rime fog', 51: 'Light drizzle',
          53: 'Drizzle', 55: 'Heavy drizzle', 61: 'Light rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Snowfall', 73: 'Snow',
          75: 'Heavy snow', 80: 'Rain showers', 81: 'Rain showers', 82: 'Heavy showers', 85: 'Snow showers', 86: 'Heavy snow showers'
        };
        return map[code] || 'Live update';
      };

      const fetchWeather = async (loc) => {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true&timezone=auto`;
        const tempEl = document.getElementById(`temp-${loc.id}`);
        const descEl = document.getElementById(`desc-${loc.id}`);
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 7000);
          const res = await fetch(url, { signal: controller.signal });
          clearTimeout(timeout);
          const json = await res.json();
          const cw = json.current_weather || {};
          const temp = cw.temperature != null ? `${cw.temperature}°C` : '—';
          const wind = cw.windspeed != null ? `Wind ${cw.windspeed} km/h` : '';
          const summary = weatherDesc(cw.weathercode);
          const observed = cw.time ? `as of ${cw.time}` : '';
          tempEl.textContent = temp;
          descEl.innerHTML = `${summary}${wind ? ' · ' + wind : ''}${observed ? ' · ' + observed : ''}${
            loc.fallback ? ` · <a target="_blank" rel="noreferrer noopener" href="${loc.fallback}">Forecast ↗</a>` : ''
          }`;
        } catch (e) {
          if (tempEl) tempEl.textContent = '—';
          if (descEl) descEl.innerHTML = loc.fallback
            ? `<a href="${loc.fallback}" target="_blank" rel="noreferrer noopener">Open local forecast</a>`
            : 'Weather unavailable';
        }
      };

      weatherCards.forEach((loc, idx) => setTimeout(() => fetchWeather(loc), idx * 400));

      // Globe
      try {
        const canvas = document.getElementById('globe');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x030711, 0);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 200);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(100, 150, 100);
        scene.add(directionalLight);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enablePan = false;
        controls.minDistance = 130;
        controls.maxDistance = 300;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.2;

        const globe = new ThreeGlobe({ animateIn: true })
          .globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
          .bumpImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-topology.png')
          .arcsData(data.routeArcs || [])
          .arcColor(() => '#38bdf8')
          .arcAltitudeAutoScale(true)
          .arcDashLength(0.4)
          .arcDashGap(0.7)
          .arcDashAnimateTime(2000)
          .pointsData(data.routePoints || [])
          .pointLat('lat')
          .pointLng('lng')
          .pointColor(() => '#e0f2fe')
          .pointRadius(0.6)
          .labelsData(data.routePoints || [])
          .labelLat('lat')
          .labelLng('lng')
          .labelText('label')
          .labelAltitude(0.05)
          .labelSize(0.8)
          .labelColor(() => '#fff');

        scene.add(globe);

        const animate = () => {
          controls.update();
          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        };
        animate();

        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      } catch (err) {
        console.error('Globe failed', err);
      }
    </script>
  </body>
</html>
