<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Japan Travel · Globe + Day Plan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/styles.css" />
    <style>
      canvas#globe {
        position: fixed;
        inset: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
        pointer-events: none;
        opacity: 0.28;
      }
      .overlay {
        position: relative;
        z-index: 1;
      }
      .panel {
        background: rgba(6, 10, 22, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1rem;
        padding: 1rem;
        box-shadow: 0 16px 52px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(14px);
      }
    </style>
  </head>
  <body>
    <canvas id="globe"></canvas>
    <div class="overlay">
      <div class="page-shell">
        <nav aria-label="Pages">
          <a class="active" href="index.html">Globe View</a>
          <a href="timeline.html">Timeline</a>
        </nav>

        <div class="hero hero-grid">
          <div class="hero-copy">
            <p class="chip">Family of 5 · PER → SIN (transit) → Tokyo/Hakuba → Singapore → PER</p>
            <h1>16 days Japan (Tokyo + Hakuba) then Singapore wind-down</h1>
            <p>Wake-to-sleep plan with booking links for hotels, food, onsen, ski days, and a no-accommodation Singapore stay.</p>
            <div class="dataset-toggle" id="dataset-toggle">
              <button type="button" data-set="jan" class="active">Jan 8–30 · Perth→Japan→Singapore</button>
              <button type="button" data-set="hakuba">Legacy Hakuba sample</button>
            </div>
            <div class="summary-grid">
              <div class="summary-chip"><strong>Trip window</strong><p>8–30 Jan</p></div>
              <div class="summary-chip"><strong>Japan days</strong><p>16 days Tokyo + Hakuba (5 ski days)</p></div>
              <div class="summary-chip"><strong>Singapore</strong><p>After Japan · staying with family</p></div>
              <div class="summary-chip"><strong>Family</strong><p>2 adults · 18yo · 14yo · 7yo</p></div>
            </div>
          </div>
          <div class="hero-visuals">
            <div class="orb a" data-parallax="0.12"></div>
            <div class="orb b" data-parallax="0.08"></div>
            <figure class="hero-photo large" data-parallax="0.28">
              <img src="tokyo.jpg" alt="Tokyo skyline night" loading="lazy" />
              <figcaption>Tokyo arrival + ramen sprint</figcaption>
            </figure>
            <figure class="hero-photo medium" data-parallax="0.2">
              <img src="hakuba.jpg" alt="Hakuba ski slopes" loading="lazy" />
              <figcaption>Hakuba ski + onsen rhythm</figcaption>
            </figure>
            <figure class="hero-photo small" data-parallax="0.14">
              <img src="singapore.jpg" alt="Singapore skyline" loading="lazy" />
              <figcaption>Singapore wind-down</figcaption>
            </figure>
          </div>
        </div>

        <section class="destinations" aria-label="Destinations preview">
          <article class="dest-card" data-parallax="0.08">
            <span class="tag">Tokyo</span>
            <img src="tokyo.jpg" alt="Tokyo streets" loading="lazy" />
            <div class="dest-body">
              <strong>City energy without overloading the kids.</strong>
              <p>Ramen, Tsukiji bites, Shibuya Sky, and easy JR access from Shinjuku/Ginza bases.</p>
              <a href="#actions-grid" class="chip">See booking links</a>
            </div>
          </article>
          <article class="dest-card" data-parallax="0.08">
            <span class="tag">Hakuba</span>
            <img src="hakuba.jpg" alt="Hakuba mountain view" loading="lazy" />
            <div class="dest-body">
              <strong>5 ski days + rest buffers.</strong>
              <p>Greens for the beginners, reds for the intermediates, onsen every evening, Snow Monkeys on the rest day.</p>
              <a href="#stays" class="chip">Stay near lifts</a>
            </div>
          </article>
          <article class="dest-card" data-parallax="0.08">
            <span class="tag">Singapore</span>
            <img src="singapore.jpg" alt="Singapore skyline at night" loading="lazy" />
            <div class="dest-body">
              <strong>Family base, no hotel needed.</strong>
              <p>Gardens by the Bay, Sentosa option, food crawl, and pool/AC downtime after Japan.</p>
              <a href="#days" class="chip">See day plan</a>
            </div>
          </article>
        </section>

        <div class="layout">
          <div class="main-column">
            <section class="resource-panel section-anchor">
              <h2>Booking + flights</h2>
              <p class="chip">Use these to lock the PER→SIN (transit)→Tokyo/Hakuba→Tokyo→SIN→PER legs</p>
              <div class="actions-grid" id="actions-grid"></div>
              <div class="flight-grid" id="flight-grid"></div>
            </section>

            <section id="days" class="cards-panel section-anchor">
              <h2>Day-by-day (wake → sleep)</h2>
              <div id="day-cards"></div>
            </section>

            <section id="stays" class="stays-panel section-anchor">
              <h2>Where to stay (Japan)</h2>
              <p class="chip">Walk-to-lifts in Hakuba · easy rail in Tokyo</p>
              <div class="stays-grid" id="stays-grid"></div>
            </section>
          </div>

          <aside class="sidebar">
            <div class="panel">
              <h3>Live info</h3>
              <p class="chip">Weather with forecast links</p>
              <div id="weather-grid">
                <div class="weather-card" data-loc="tokyo">
                  <div class="title">Tokyo</div>
                  <div class="temp" id="temp-tokyo">Loading…</div>
                  <div class="desc" id="desc-tokyo"></div>
                </div>
                <div class="weather-card" data-loc="hakuba">
                  <div class="title">Hakuba</div>
                  <div class="temp" id="temp-hakuba">Loading…</div>
                  <div class="desc" id="desc-hakuba"></div>
                </div>
              </div>
            </div>
            <div class="panel">
              <h3>Emergency</h3>
              <p class="chip">110 police · 119 ambulance/fire</p>
              <ul class="sidebar-links" id="emergency-links"></ul>
            </div>
            <div class="panel">
              <h3>Slope maps</h3>
              <p class="chip">Trail maps (new tab)</p>
              <ul class="sidebar-links" id="map-links"></ul>
            </div>
            <div class="panel">
              <h3>Cams & news</h3>
              <p class="chip">Open in new tab</p>
              <ul class="sidebar-links" id="cam-links"></ul>
              <ul class="sidebar-links" id="news-links"></ul>
            </div>
          </aside>
        </div>
      </div>
    </div>

    <script src="data.js?v=7"></script>
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.163.0/build/three.module.js';
      import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/controls/OrbitControls.js';
      import ThreeGlobe from 'https://cdn.jsdelivr.net/npm/three-globe@2.27.12/dist/three-globe.module.js';

      const data = window.TripData || {};
      const datasets = { hakuba: data.hakuba || [], jan: data.januaryPlan || [] };
      let currentSet = 'jan';

      const dayCards = document.getElementById('day-cards');
      const actionsGrid = document.getElementById('actions-grid');
      const flightGrid = document.getElementById('flight-grid');
      const staysGrid = document.getElementById('stays-grid');
      const newsList = document.getElementById('news-links');
      const camList = document.getElementById('cam-links');
      const mapLinks = document.getElementById('map-links');
      const emergencyList = document.getElementById('emergency-links');
      const weatherCards = [
        { id: 'tokyo', lat: 35.68, lon: 139.76, title: 'Tokyo', fallback: 'https://www.jma.go.jp/bosai/nowc/#area_type=offices&area_code=130000&center=130&zoom=9' },
        { id: 'hakuba', lat: 36.69, lon: 137.83, title: 'Hakuba', fallback: 'https://www.jma.go.jp/bosai/nowc/#lat=36.69&lon=137.83&zoom=10' }
      ];
      let cardObserver = null;

      const parallaxItems = Array.from(document.querySelectorAll('[data-parallax]'));
      let mouseX = window.innerWidth / 2;
      let mouseY = window.innerHeight / 2;
      let raf;
      const updateParallax = () => {
        const midX = window.innerWidth / 2;
        const midY = window.innerHeight / 2;
        parallaxItems.forEach((el) => {
          const speed = parseFloat(el.dataset.parallax || '0.2');
          const rect = el.getBoundingClientRect();
          const offsetY = (rect.top - window.innerHeight / 2) * speed * -0.05;
          const dx = ((mouseX - midX) / midX) * speed * 12;
          const dy = ((mouseY - midY) / midY) * speed * 10 + offsetY;
          el.style.transform = `translate3d(${dx}px, ${dy}px, 0)`;
        });
      };
      const queueParallax = () => {
        if (raf) return;
        raf = requestAnimationFrame(() => {
          updateParallax();
          raf = null;
        });
      };
      window.addEventListener('pointermove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        queueParallax();
      });
      window.addEventListener('scroll', queueParallax, { passive: true });
      queueParallax();

      const attachCardFocus = () => {
        if (cardObserver) cardObserver.disconnect();
        cardObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => entry.target.classList.toggle('active', entry.isIntersecting && entry.intersectionRatio > 0.5));
          },
          { threshold: [0.35, 0.5, 0.75] }
        );
        document.querySelectorAll('.day-card').forEach((card) => cardObserver.observe(card));
      };

      const renderActions = () => {
        actionsGrid.innerHTML = '';
        (data.actions || []).forEach((action) => {
          const card = document.createElement('article');
          card.className = 'action-card';
          card.innerHTML = `
            <h3>${action.title}</h3>
            <p>${action.detail}</p>
            <a href="${action.link}" target="_blank" rel="noreferrer noopener">Open →</a>
          `;
          actionsGrid.appendChild(card);
        });
      };

      const renderFlights = () => {
        flightGrid.innerHTML = '';
        (data.flightOptions || []).forEach((f) => {
          const card = document.createElement('article');
          card.className = 'flight-card';
          card.innerHTML = `
            <h3>${f.leg}</h3>
            <div class="meta">${f.dates} · ${f.carrier}</div>
            <div class="chip">${f.times} · ${f.duration}</div>
            ${f.price ? `<div class="chip">Est. price: ${f.price}</div>` : ''}
            <p class="meta">${f.note}</p>
          `;
          flightGrid.appendChild(card);
        });
      };

      const renderStays = () => {
        staysGrid.innerHTML = '';
        (data.stays || []).forEach((item) => {
          const card = document.createElement('article');
          card.className = 'stay-card';
          card.innerHTML = `
            ${item.image ? `<img src="${item.image}" alt="${item.title}" loading="lazy" />` : ''}
            <h3>${item.title}</h3>
            <p>${item.area}</p>
            <p>${item.detail}</p>
            ${item.link ? `<a target="_blank" rel="noreferrer noopener" href="${item.link}">View options →</a>` : ''}
          `;
          staysGrid.appendChild(card);
        });
      };

      const renderMaps = () => {
        mapLinks.innerHTML = '';
        (data.slopeMaps || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a><div class="meta">${item.area || ''}</div>`;
          mapLinks.appendChild(li);
        });
      };

      const renderNews = () => {
        newsList.innerHTML = '';
        (data.newsFeeds || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a><div class="meta">${item.detail}</div>`;
          newsList.appendChild(li);
        });
      };

      const renderCams = () => {
        camList.innerHTML = '';
        (data.slopeCams || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a><div class="meta">${item.detail}</div>`;
          camList.appendChild(li);
        });
      };

      const renderEmergency = () => {
        emergencyList.innerHTML = '';
        (data.emergencyInfo || []).forEach((item) => {
          const li = document.createElement('li');
          li.innerHTML = `${item.link ? `<a target="_blank" rel="noreferrer noopener" href="${item.link}">${item.title}</a>` : `<strong>${item.title}</strong>`}<div class="meta">${item.detail}</div>`;
          emergencyList.appendChild(li);
        });
      };

      const buildCard = (entry) => {
        const card = document.createElement('article');
        card.className = 'day-card';
        const planSteps = entry.plan.split(';').map((s) => s.trim()).filter(Boolean);
        const baseLoc = entry.location?.split('→')[0]?.trim();
        const gallery = data.galleryMap?.[entry.location] || (baseLoc && data.galleryMap?.[baseLoc]) || data.galleryMap?.Tokyo || [];
        const energy = data.energyMap[entry.date] || {};
        const heroImg = gallery[0] || '';

        const scheduleItems = planSteps.map((step) => {
          const match = step.match(/^(\d{1,2}:\d{2}(?:[–-]\d{1,2}:\d{2})?)\s+(.*)$/);
          if (match) {
            return { time: match[1], desc: match[2] };
          }
          return { time: '', desc: step };
        });

        const energyMarkup = Object.entries(energy)
          .map(
            ([person, level]) => `
              <span class="energy-pill ${level.toLowerCase()}">${person}: <span>${level}</span></span>
            `
          )
          .join('');

        card.innerHTML = `
          <div class="day-media" style="${heroImg ? `background-image:url(${heroImg})` : ''}">
            <div class="day-media-overlay">
              <div class="chips">
                <span class="chip">Food mid: $${entry.food}</span>
                ${entry.focus ? `<span class="chip">Ski focus: ${entry.focus}</span>` : '<span class="chip">Buffer-smart pacing</span>'}
              </div>
            </div>
          </div>
          <div class="day-body">
            <div class="day-header">
              <div>
                <p class="card-date">${entry.date}</p>
                <h3>${entry.location}</h3>
              </div>
              <div class="chips energy-stack">
                ${energyMarkup || '<span class="chip">Balanced energy</span>'}
              </div>
            </div>
            <ul class="schedule-list">
              ${scheduleItems
                .map(
                  (item) => `
                    <li class="schedule-item">
                      <span class="schedule-time">${item.time || 'Anytime'}</span>
                      <span class="schedule-desc">${item.desc}</span>
                    </li>
                  `
                )
                .join('')}
            </ul>
            <p class="schedule-desc"><strong>Hint:</strong> ${entry.hint || ''}</p>
          </div>
        `;
        return card;
      };

      const renderDays = (key) => {
        dayCards.innerHTML = '';
        const list = datasets[key] || [];
        if (!list.length) {
          dayCards.innerHTML = '<p class="chip">No days available for this plan.</p>';
          return;
        }
        list.forEach((day) => dayCards.appendChild(buildCard(day)));
        attachCardFocus();
      };

      document.querySelectorAll('#dataset-toggle button').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#dataset-toggle button').forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          currentSet = btn.dataset.set;
          renderDays(currentSet);
        });
      });

      renderActions();
      renderFlights();
      renderStays();
      renderMaps();
      renderNews();
      renderCams();
      renderEmergency();
      renderDays(currentSet);

      const weatherDesc = (code) => {
        const map = {
          0: 'Clear', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast', 45: 'Foggy', 48: 'Rime fog', 51: 'Light drizzle',
          53: 'Drizzle', 55: 'Heavy drizzle', 61: 'Light rain', 63: 'Rain', 65: 'Heavy rain', 71: 'Snowfall', 73: 'Snow',
          75: 'Heavy snow', 80: 'Rain showers', 81: 'Rain showers', 82: 'Heavy showers', 85: 'Snow showers', 86: 'Heavy snow showers'
        };
        return map[code] || 'Live update';
      };

      const fetchWeather = async (loc) => {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&current_weather=true&timezone=auto`;
        const tempEl = document.getElementById(`temp-${loc.id}`);
        const descEl = document.getElementById(`desc-${loc.id}`);
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 7000);
          const res = await fetch(url, { signal: controller.signal });
          clearTimeout(timeout);
          const json = await res.json();
          const cw = json.current_weather || {};
          const temp = cw.temperature != null ? `${cw.temperature}°C` : '—';
          const wind = cw.windspeed != null ? `Wind ${cw.windspeed} km/h` : '';
          const summary = weatherDesc(cw.weathercode);
          const observed = cw.time ? `as of ${cw.time}` : '';
          tempEl.textContent = temp;
          descEl.innerHTML = `${summary}${wind ? ' · ' + wind : ''}${observed ? ' · ' + observed : ''}${
            loc.fallback ? ` · <a target="_blank" rel="noreferrer noopener" href="${loc.fallback}">Forecast ↗</a>` : ''
          }`;
        } catch (e) {
          if (tempEl) tempEl.textContent = '—';
          if (descEl) descEl.innerHTML = loc.fallback
            ? `<a href="${loc.fallback}" target="_blank" rel="noreferrer noopener">Open local forecast</a>`
            : 'Weather unavailable';
        }
      };

      weatherCards.forEach((loc, idx) => setTimeout(() => fetchWeather(loc), idx * 400));

      // Globe
      try {
        const canvas = document.getElementById('globe');
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0x030711, 0);

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 200);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(100, 150, 100);
        scene.add(directionalLight);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enablePan = false;
        controls.minDistance = 130;
        controls.maxDistance = 300;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.2;

        const globe = new ThreeGlobe({ animateIn: true })
          .globeImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-night.jpg')
          .bumpImageUrl('https://cdn.jsdelivr.net/npm/three-globe/example/img/earth-topology.png')
          .arcsData(data.routeArcs || [])
          .arcColor(() => '#38bdf8')
          .arcAltitudeAutoScale(true)
          .arcDashLength(0.4)
          .arcDashGap(0.7)
          .arcDashAnimateTime(2000)
          .pointsData(data.routePoints || [])
          .pointLat('lat')
          .pointLng('lng')
          .pointColor(() => '#e0f2fe')
          .pointRadius(0.6)
          .labelsData(data.routePoints || [])
          .labelLat('lat')
          .labelLng('lng')
          .labelText('label')
          .labelAltitude(0.05)
          .labelSize(0.8)
          .labelColor(() => '#fff');

        scene.add(globe);

        const animate = () => {
          controls.update();
          renderer.render(scene, camera);
          requestAnimationFrame(animate);
        };
        animate();

        window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        });
      } catch (err) {
        console.error('Globe failed', err);
      }
    </script>
  </body>
</html>
